import React, { useState, useEffect, useCallback, useRef } from 'react';
import { Smartphone, Signal, Battery, ChevronUp, ChevronDown, ChevronLeft, ChevronRight, Skull, AlertCircle } from 'lucide-react';

const GRID_SIZE = 20;
const INITIAL_SNAKE = [{ x: 10, y: 10 }];
const INITIAL_DIRECTION = { x: 1, y: 0 };

const App = () => {
  const [snake, setSnake] = useState(INITIAL_SNAKE);
  const [food, setFood] = useState({ x: 5, y: 5 });
  const [direction, setDirection] = useState(INITIAL_DIRECTION);
  const [score, setScore] = useState(0);
  const [highScore, setHighScore] = useState(0);
  const [stage, setStage] = useState(1);
  const [gameState, setGameState] = useState('menu'); // 'menu', 'playing', 'levelup', 'HELL'
  const [isScary, setIsScary] = useState(false);
  
  const audioRetroRef = useRef(null);
  const audioScaryRef = useRef(null);
  const gameLoopRef = useRef(null);
  const directionRef = useRef(INITIAL_DIRECTION);

  // Sound Management
  const stopAllAudio = () => {
    if (audioRetroRef.current) { audioRetroRef.current.pause(); audioRetroRef.current.currentTime = 0; }
    if (audioScaryRef.current) { audioScaryRef.current.pause(); audioScaryRef.current.currentTime = 0; }
  };

  const playRetro = () => {
    stopAllAudio();
    if (audioRetroRef.current) audioRetroRef.current.play().catch(() => {});
  };

  const playScary = () => {
    stopAllAudio();
    if (audioScaryRef.current) {
      audioScaryRef.current.volume = 1.0;
      audioScaryRef.current.play().catch(() => {});
    }
  };

  const generateFood = useCallback(() => {
    let newFood;
    while (true) {
      newFood = {
        x: Math.floor(Math.random() * GRID_SIZE),
        y: Math.floor(Math.random() * GRID_SIZE),
      };
      if (!snake.some(s => s.x === newFood.x && s.y === newFood.y)) break;
    }
    setFood(newFood);
  }, [snake]);

  const moveSnake = useCallback(() => {
    if (gameState !== 'playing' && gameState !== 'HELL') return;

    setSnake((prev) => {
      const head = prev[0];
      // Wraparound Logic (Wall pass)
      const newHead = {
        x: (head.x + directionRef.current.x + GRID_SIZE) % GRID_SIZE,
        y: (head.y + directionRef.current.y + GRID_SIZE) % GRID_SIZE,
      };

      // Body Collision Check
      if (prev.some(s => s.x === newHead.x && s.y === newHead.y)) {
        setGameState('gameover');
        return prev;
      }

      const newSnake = [newHead, ...prev];

      if (newHead.x === food.x && newHead.y === food.y) {
        const newScore = score + 1;
        setScore(newScore);
        if (newScore > highScore) setHighScore(newScore);
        generateFood();

        // Level Progression
        if (stage === 1 && newScore >= 3) {
          setGameState('levelup');
        } else if (stage === 2 && newScore >= 5) {
          setGameState('levelup');
        }
      } else {
        newSnake.pop();
      }
      return newSnake;
    });
  }, [food, score, stage, gameState, generateFood, highScore]);

  useEffect(() => {
    if (gameState === 'playing' || gameState === 'HELL') {
      const speed = isScary ? 60 : (160 - (stage * 30));
      gameLoopRef.current = setInterval(moveSnake, speed);
    } else {
      clearInterval(gameLoopRef.current);
    }
    return () => clearInterval(gameLoopRef.current);
  }, [gameState, moveSnake, stage, isScary]);

  const handleStart = (targetStage) => {
    setSnake(INITIAL_SNAKE);
    directionRef.current = INITIAL_DIRECTION;
    setDirection(INITIAL_DIRECTION);
    setScore(0);
    setStage(targetStage);
    
    if (targetStage === 3) {
      setIsScary(true);
      setGameState('HELL');
      playScary();
    } else {
      setIsScary(false);
      setGameState('playing');
      playRetro();
    }
  };

  const updateDirection = (newDir) => {
    // If nightmare active, sometimes invert controls randomly to frustrate
    let finalDir = newDir;
    if (isScary && Math.random() > 0.9) {
        finalDir = { x: -newDir.x, y: -newDir.y };
    }

    if (finalDir.x !== -directionRef.current.x || finalDir.y !== -directionRef.current.y) {
      directionRef.current = finalDir;
      setDirection(finalDir);
    }
  };

  return (
    <div className={`min-h-screen w-full flex flex-col items-center justify-center p-4 transition-all duration-700 font-sans select-none overflow-hidden
      ${isScary ? 'bg-black' : 'bg-slate-200'}`}>
      
      {/* JUMPSCARE VISUALS */}
      {isScary && (
        <div className="fixed inset-0 z-[100] pointer-events-none overflow-hidden">
          <div className="absolute inset-0 bg-red-950/20 animate-pulse"></div>
          <div className="absolute inset-0 shadow-[inset_0_0_150px_rgba(150,0,0,0.8)]"></div>
          
          {/* Creepy Text Blinks */}
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white/5 text-[150px] font-serif italic animate-ping">
            DIE
          </div>
          
          {/* Glitch Slices */}
          <div className="absolute top-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/asfalt-dark.png')] opacity-30 mix-blend-color-dodge animate-[vibrate_0.05s_infinite]"></div>
          <div className="absolute top-[20%] w-full h-1 bg-red-600 animate-[glitch_0.1s_infinite]"></div>
          <div className="absolute top-[70%] w-full h-2 bg-red-900 animate-[glitch_0.15s_infinite_reverse]"></div>
        </div>
      )}

      {/* HEADER SCOREBOARD */}
      <div className={`mb-6 flex justify-between w-full max-w-[360px] px-4 font-mono font-bold transition-colors
        ${isScary ? 'text-red-700' : 'text-slate-600'}`}>
        <div className="flex flex-col">
          <span className="text-[10px]">CURRENT SCORE</span>
          <span className="text-2xl tracking-widest">{String(score).padStart(3, '0')}</span>
        </div>
        <div className="flex flex-col items-end">
          <span className="text-[10px]">HI-SCORE</span>
          <span className="text-2xl tracking-widest">{String(highScore).padStart(3, '0')}</span>
        </div>
      </div>

      {/* NOKIA PHONE BODY */}
      <div className={`relative w-full max-w-[360px] aspect-[9/18.5] rounded-[3.8rem] border-[12px] p-6 shadow-2xl transition-all duration-300
        ${isScary ? 'bg-zinc-950 border-red-950 scale-105 rotate-1' : 'bg-slate-300 border-slate-400'}`}>
        
        {/* TOP LOGO AREA */}
        <div className="flex flex-col items-center mb-6">
          <div className="w-14 h-1.5 bg-black/20 rounded-full mb-3"></div>
          <div className={`text-xl font-black italic tracking-tighter transition-colors ${isScary ? 'text-red-600' : 'text-slate-800'}`}>
            {isScary ? "SNAKE_CORRUPT" : "SNAKE XENZIA"}
          </div>
        </div>

        {/* LCD SCREEN */}
        <div className={`relative w-full aspect-[4/3] border-[6px] border-slate-600 rounded-sm overflow-hidden flex flex-col transition-all duration-500
          ${isScary ? 'bg-red-950 grayscale invert contrast-[4] brightness-[0.4] scale-110' : 'bg-[#98b000]'}`}>
          
          {/* SCREEN INFO BAR */}
          <div className="flex justify-between items-center px-1 border-b border-black/20 text-[9px] font-bold text-black/80">
            <div className="flex items-center gap-0.5"><Signal size={8} /> <span className="mt-0.5">3G</span></div>
            <span className="uppercase">{isScary ? "HELL" : `Stage ${stage}`}</span>
            <Battery size={10} />
          </div>

          {/* SCREEN CONTENT */}
          <div className="flex-1 relative">
            {gameState === 'menu' && (
              <div className="flex flex-col items-center justify-center h-full text-black font-bold uppercase p-2 text-center">
                <div className="text-xs mb-1 opacity-60">Retro Emulator</div>
                <div className="bg-black text-[#98b000] px-4 py-1 text-sm tracking-widest animate-pulse">NEW GAME</div>
                <button 
                  onClick={() => handleStart(1)}
                  className="mt-4 border-2 border-black px-6 py-1 text-xs hover:bg-black hover:text-[#98b000] transition-colors">
                  SELECT
                </button>
              </div>
            )}

            {(gameState === 'playing' || gameState === 'HELL') && (
              <div className="w-full h-full">
                {snake.map((s, i) => (
                  <div 
                    key={i}
                    className={`absolute border border-black/5 ${isScary ? 'bg-white shadow-[0_0_8px_white]' : 'bg-black'}`}
                    style={{ 
                      width: `${100/GRID_SIZE}%`, height: `${100/GRID_SIZE}%`,
                      left: `${(s.x * 100) / GRID_SIZE}%`, top: `${(s.y * 100) / GRID_SIZE}%`,
                      opacity: isScary ? 1 - (i*0.03) : 1
                    }}
                  />
                ))}
                <div 
                  className={`absolute rounded-full ${isScary ? 'bg-red-500 animate-ping' : 'bg-black'}`}
                  style={{ 
                    width: `${100/GRID_SIZE}%`, height: `${100/GRID_SIZE}%`,
                    left: `${(food.x * 100) / GRID_SIZE}%`, top: `${(food.y * 100) / GRID_SIZE}%`
                  }}
                />
              </div>
            )}

            {gameState === 'levelup' && (
              <div className="absolute inset-0 bg-[#98b000] z-50 flex flex-col items-center justify-center text-black p-4 text-center">
                <Skull size={24} className="mb-2 opacity-10" />
                <h2 className="text-lg font-bold">LEVEL UP!</h2>
                <p className="text-[10px] mb-4 opacity-70">NEURAL ARCHIVE SYNCED</p>
                <button 
                  onClick={() => handleStart(stage + 1)}
                  className="bg-black text-[#98b000] px-6 py-2 font-bold text-xs uppercase active:scale-95 transition-transform">
                  NEXT LEVEL
                </button>
              </div>
            )}

            {gameState === 'gameover' && (
              <div className="flex flex-col items-center justify-center h-full text-black font-bold uppercase bg-[#98b000] p-4 text-center">
                <AlertCircle size={32} className="mb-2" />
                <div className="text-base">FATAL ERROR</div>
                <div className="text-[8px] mt-1 mb-4">SYSTEM STACK OVERFLOW</div>
                <button 
                  onClick={() => handleStart(1)}
                  className="border-2 border-black px-4 py-1 text-[10px]">
                  REBOOT SYSTEM
                </button>
              </div>
            )}
          </div>
        </div>

        {/* PHYSICAL KEYPAD */}
        <div className="mt-8 flex flex-col items-center gap-2">
          <div className="grid grid-cols-3 gap-3 w-full px-2">
            <button className="h-10 rounded-full border-b-4 border-slate-400 bg-slate-200"></button>
            <button 
              onMouseDown={() => updateDirection({x:0, y:-1})}
              className="h-16 rounded-2xl border-4 border-slate-400 bg-slate-100 flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                <ChevronUp className="text-slate-600" />
            </button>
            <button className="h-10 rounded-full border-b-4 border-slate-400 bg-slate-200"></button>

            <button 
              onMouseDown={() => updateDirection({x:-1, y:0})}
              className="h-16 rounded-2xl border-4 border-slate-400 bg-slate-100 flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                <ChevronLeft className="text-slate-600" />
            </button>
            <button className="h-16 rounded-2xl border-4 border-slate-400 bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500">5</button>
            <button 
              onMouseDown={() => updateDirection({x:1, y:0})}
              className="h-16 rounded-2xl border-4 border-slate-400 bg-slate-100 flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                <ChevronRight className="text-slate-600" />
            </button>

            <button className="h-10 rounded-full border-b-4 border-slate-400 bg-slate-200"></button>
            <button 
              onMouseDown={() => updateDirection({x:0, y:1})}
              className="h-16 rounded-2xl border-4 border-slate-400 bg-slate-100 flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                <ChevronDown className="text-slate-600" />
            </button>
            <button className="h-10 rounded-full border-b-4 border-slate-400 bg-slate-200"></button>
          </div>
        </div>
      </div>

      {/* FOOTER TEXT */}
      <div className={`mt-8 font-mono text-[9px] uppercase tracking-[0.3em] transition-colors duration-1000 ${isScary ? 'text-red-900 opacity-20' : 'text-slate-400 opacity-40'}`}>
        Neural-X Link Interface | Stable Build 4.0.0
      </div>

      {/* HIDDEN AUDIO ELEMENTS */}
      {/* 8-bit Classic Music (Levels 1-2) */}
      <audio ref={audioRetroRef} loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" type="audio/mpeg" />
      </audio>
      
      {/* Jumpscare/Creepy Audio (Level 3 - Immediate) */}
      <audio ref={audioScaryRef} loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3" type="audio/mpeg" />
      </audio>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes vibrate {
          0%, 100% { transform: translate(0, 0); }
          25% { transform: translate(3px, -3px); }
          50% { transform: translate(-3px, 3px); }
          75% { transform: translate(1px, 1px); }
        }
        @keyframes glitch {
          0% { clip-path: inset(10% 0 80% 0); transform: translateX(-10px); }
          20% { clip-path: inset(80% 0 10% 0); transform: translateX(10px); }
          40% { clip-path: inset(30% 0 30% 0); transform: skewX(20deg); }
          60% { clip-path: inset(5% 0 90% 0); transform: translateX(-5px); }
          80% { clip-path: inset(90% 0 5% 0); transform: skewX(-20deg); }
          100% { clip-path: inset(10% 0 80% 0); }
        }
      `}} />
    </div>
  );
};

export default App;

